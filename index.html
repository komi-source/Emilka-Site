<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–≠–º–∏–ª—å –ì–∏–µ–Ω–æ–≤–∏—á ‚Äî –ê–≤–∞–Ω—Ç—é—Ä—ã</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lora:ital,wght@0,400;1,500&family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #c6a667;
            --bg: #080808;
            --card-bg: #121212;
            --reader-bg: #0d0d0d;
        }

        body { 
            background-color: var(--bg); color: #e0e0e0; font-family: 'Lora', serif; 
            margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å–≤–µ—Ä—Ö—É */
        .progress-line { 
            position: fixed; top: 0; left: 0; height: 3px; 
            background: var(--gold); width: 0%; z-index: 10000; transition: width 0.2s; 
        }

        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é) */
        #main-ui { position: relative; width: 100%; min-height: 100vh; z-index: 10; }
        
        .hero { 
            height: 40vh; display: flex; flex-direction: column; justify-content: center; 
            align-items: center; text-align: center; padding: 20px;
        }
        .hero-title { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 2.2rem; letter-spacing: 4px; text-transform: uppercase; margin: 0; }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px; }
        .chapters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }

        .chapter-card {
            background: var(--card-bg); border: 1px solid #222; border-radius: 16px;
            padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.3s;
        }
        .chapter-card:active { transform: scale(0.98); }
        .chapter-card.completed { border-color: #2ecc71; }

        /* –ö–æ–ª—å—Ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ */
        .prog-svg { width: 48px; height: 48px; transform: rotate(-90deg); margin-bottom: 8px; }
        .prog-bg { fill: none; stroke: #222; stroke-width: 4; }
        .prog-fg { fill: none; stroke: var(--gold); stroke-width: 4; stroke-linecap: round; transition: 0.5s; }

        /* --- –ß–ò–¢–ê–õ–ö–ê (READER) --- */
        #reader { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 9000; overflow-y: auto; overflow-x: hidden;
            background-color: var(--reader-bg); 
            transition: background 0.4s ease;
        }

        .toolbar { 
            position: sticky; top: 0; display: flex; justify-content: space-between; 
            align-items: center; padding: 12px 15px; z-index: 9500;
            background: inherit; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .book-content { 
            max-width: 650px; margin: 0 auto; padding: 40px 20px 50px; 
            line-height: 1.8; font-size: 1.25rem; min-height: 80vh;
            transition: color 0.4s ease;
        }

        .tool-btn { 
            background: rgba(255,255,255,0.05); border: 1.5px solid var(--gold); 
            color: var(--gold); padding: 8px 12px; font-size: 0.75rem; 
            border-radius: 10px; font-family: 'Montserrat'; font-weight: bold;
        }

        .btn-group { display: flex; gap: 8px; }

        /* –¢–µ–º—ã */
        .theme-paper { background-color: #f4f1ea !important; color: #1a1a1a !important; }
        .theme-dark { background-color: #0d0d0d !important; color: #d1d1d1 !important; }

        /* –§—É—Ç–µ—Ä —á–∏—Ç–∞–ª–∫–∏ */
        .nav-footer { 
            max-width: 650px; margin: 0 auto; padding: 0 20px 100px; 
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            background: inherit;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–æ–ª–æ—Ç–æ–≥–æ —Å–∏—è–Ω–∏—è */
        @keyframes gold-victory {
            0% { box-shadow: inset 0 0 0 transparent; }
            50% { box-shadow: inset 0 0 100px rgba(198, 166, 103, 0.5); }
            100% { box-shadow: inset 0 0 0 transparent; }
        }
        .victory-flash { animation: gold-victory 2s ease-out; }

        #toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: var(--gold); color: #000; padding: 12px 28px; 
            border-radius: 50px; font-size: 0.85rem; display: none; z-index: 11000;
            font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="toast"></div>
<div class="progress-line" id="progLine"></div>

<div id="main-ui">
    <div class="hero">
        <h1 class="hero-title">–≠–º–∏–ª—å –ì–∏–µ–Ω–æ–≤–∏—á</h1>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="tool-btn" onclick="openComments('global')">üí¨ –ß–ê–¢</button>
            <button class="tool-btn" onclick="getEmilAdvice()">üîÆ –°–û–í–ï–¢</button>
        </div>
    </div>
    <div class="container" id="volumes-container"></div>
</div>

<div id="reader" onscroll="handleReaderScroll()">
    <div class="toolbar" id="readerBar">
        <button class="tool-btn" onclick="closeBook()">‚Üê –ú–ï–ù–Æ</button>
        <div class="btn-group">
            <button class="tool-btn" onclick="changeFontSize(-2)">A-</button>
            <button class="tool-btn" onclick="changeFontSize(2)">A+</button>
            <button class="tool-btn" onclick="setReaderTheme('paper')">üìú</button>
            <button class="tool-btn" onclick="setReaderTheme('dark')">üåò</button>
        </div>
    </div>

    <div class="book-content theme-dark" id="bookText">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 id="chapterNum" style="font-family: 'Playfair Display'; margin: 0; color: var(--gold); font-size: 2.2rem;"></h1>
            <p id="chapterTitle" style="font-style: italic; opacity: 0.6; margin-top: 10px;"></p>
        </div>
        <div id="chapterBodyContent"></div>
    </div>

    <div class="nav-footer">
        <button class="tool-btn" style="padding: 18px 40px; width: 100%; font-size: 1rem;" id="commBtn">üí¨ –û–ë–°–£–î–ò–¢–¨ –ì–õ–ê–í–£</button>
        <div style="display: flex; gap: 15px; width: 100%;">
            <button class="tool-btn" style="flex: 1;" onclick="prevChapter()">‚Üê –ù–ê–ó–ê–î</button>
            <button class="tool-btn" style="flex: 1;" onclick="nextChapter()">–í–ü–ï–†–ï–î ‚Üí</button>
        </div>
    </div>
</div>

<script src="chapters.js"></script>

<script>
    const readerEl = document.getElementById('reader');
    const progLine = document.getElementById('progLine');
    let currentId = 1;
    let finishTriggered = false;

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const saveProg = (id, perc, pos) => localStorage.setItem(`emil_v4_prog_${id}`, JSON.stringify({perc, pos}));
    const loadProg = (id) => JSON.parse(localStorage.getItem(`emil_v4_prog_${id}`) || '{"perc":0,"pos":0}');

    function handleReaderScroll() {
        const scrolled = (readerEl.scrollTop / (readerEl.scrollHeight - readerEl.clientHeight)) * 100;
        progLine.style.width = scrolled + "%";

        // –ó–æ–ª–æ—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≤ –∫–æ–Ω—Ü–µ
        if (scrolled > 99 && !finishTriggered) {
            finishTriggered = true;
            readerEl.classList.add('victory-flash');
            showToast("‚ú® –ì–ª–∞–≤–∞ –∏–∑—É—á–µ–Ω–∞ –¥–æ –∫–æ–Ω—Ü–∞!");
            setTimeout(() => readerEl.classList.remove('victory-flash'), 2000);
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
        clearTimeout(window.scrollSaveTimer);
        window.scrollSaveTimer = setTimeout(() => {
            saveProg(currentId, Math.round(scrolled), readerEl.scrollTop);
        }, 300);
    }

    function openChapter(id) {
        currentId = id;
        const chapter = bookData.find(c => c.id === id);
        if(!chapter) return;

        finishTriggered = false;
        document.getElementById('chapterNum').innerText = `–ì–ª–∞–≤–∞ ${chapter.id}`;
        document.getElementById('chapterTitle').innerText = chapter.title;
        document.getElementById('chapterBodyContent').innerText = chapter.content;
        
        // –ö–Ω–æ–ø–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥–ª–∞–≤—ã
        document.getElementById('commBtn').onclick = () => {
            if(window.openComments) window.openComments(id);
        };

        readerEl.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        const saved = loadProg(id);
        setTimeout(() => { readerEl.scrollTop = saved.pos; }, 50);
    }

    function setReaderTheme(t) {
        const textContainer = document.getElementById('bookText');
        if(t === 'paper') {
            textContainer.className = 'book-content theme-paper';
            readerEl.style.backgroundColor = '#f4f1ea';
        } else {
            textContainer.className = 'book-content theme-dark';
            readerEl.style.backgroundColor = '#0d0d0d';
        }
    }

    function changeFontSize(delta) {
        const el = document.getElementById('bookText');
        const style = window.getComputedStyle(el, null).getPropertyValue('font-size');
        const currentSize = parseFloat(style);
        if ((currentSize + delta) > 12 && (currentSize + delta) < 40) {
            el.style.fontSize = (currentSize + delta) + 'px';
        }
    }

    function closeBook() {
        readerEl.style.display = 'none';
        document.body.style.overflow = 'auto';
        renderVolumes(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
    }

    function nextChapter() { if(currentId < bookData.length) openChapter(currentId + 1); }
    function prevChapter() { if(currentId > 1) openChapter(currentId - 1); }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    function getEmilAdvice() {
        const advices = [
            "–ï—Å–ª–∏ —Ç–µ–±—è –ø–æ–π–º–∞–ª–∏ ‚Äî –ø—Ä–∏—Ç–≤–æ—Ä–∏—Å—å, —á—Ç–æ —Ç—ã —ç—Ç–æ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª.",
            "–®–∞–∫–∞–ª—ã –ª–∞—é—Ç –Ω–∞ –ª—É–Ω—É, –∞ –≠–º–∏–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç –ª—É–Ω—É —Å–µ–±–µ.",
            "–î–µ–Ω—å–≥–∏ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ø–æ—Å–æ–± –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç—ã –ø—Ä–∞–≤."
        ];
        showToast(advices[Math.floor(Math.random()*advices.length)]);
    }

    function renderVolumes() {
        const container = document.getElementById('volumes-container');
        container.innerHTML = '';
        
        const volumes = [
            { name: "–¢–æ–º I: –ù–∞—á–∞–ª–æ", range: [1, 22] },
            { name: "–¢–æ–º II: –ê–≤–∞–Ω—Ç—é—Ä—ã", range: [23, 100] }
        ];

        volumes.forEach(v => {
            const chaptersInVol = bookData.filter(c => c.id >= v.range[0] && c.id <= v.range[1]);
            if(chaptersInVol.length === 0) return;

            const volEl = document.createElement('div');
            volEl.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin:40px 0 20px;">
                    <h2 style="color:var(--gold); font-size:1.1rem; margin:0; text-transform:uppercase;">${v.name}</h2>
                    <div style="flex:1; height:1px; background:linear-gradient(90deg, var(--gold), transparent);"></div>
                </div>
                <div class="chapters-grid"></div>
            `;
            
            const grid = volEl.querySelector('.chapters-grid');
            chaptersInVol.forEach(ch => {
                const prog = loadProg(ch.id);
                const isCompleted = prog.perc >= 98;
                const strokeOffset = 125.6 - (125.6 * (prog.perc / 100)); // r=20

                const card = document.createElement('div');
                card.className = `chapter-card ${isCompleted ? 'completed' : ''}`;
                card.onclick = () => openChapter(ch.id);
                card.innerHTML = `
                    <svg class="prog-svg">
                        <circle class="prog-bg" cx="24" cy="24" r="20"></circle>
                        <circle class="prog-fg" cx="24" cy="24" r="20" style="stroke-dashoffset:${strokeOffset}; stroke-dasharray:125.6; ${isCompleted ? 'stroke:#2ecc71' : ''}"></circle>
                    </svg>
                    <div style="font-weight:bold; font-size:0.9rem;">–ì–ª–∞–≤–∞ ${ch.id}</div>
                    <div style="font-size:0.6rem; opacity:0.5; margin-top:4px;">${isCompleted ? '–ó–ê–í–ï–†–®–ï–ù–û' : prog.perc + '%'}</div>
                `;
                grid.appendChild(card);
            });
            container.appendChild(volEl);
        });
    }

    // –ü–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    renderVolumes();
</script>

</body>
</html>
