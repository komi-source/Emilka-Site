<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—Ä–∏—á—É–¥–ª–∏–≤—ã–µ –∞–≤–∞–Ω—Ç—é—Ä—ã –≠–º–∏–ª—è –ì–∏–µ–Ω–æ–≤–∏—á–∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lora:ital,wght@0,400;1,500&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #c6a667;
            --bg: #080808;
            --card-bg: #121212;
            --sepia-bg: #2b2520;
            --sepia-text: #d3bc9f;
            --toolbar-bg: rgba(18, 18, 18, 0.95);
        }

        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Lora', serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.5s ease; }
        
        .progress-line { position: fixed; top: 0; left: 0; height: 3px; background: var(--gold); width: 0%; z-index: 10000; transition: width 0.3s; }

        /* –°—á–µ—Ç—á–∏–∫ –æ–Ω–ª–∞–π–Ω */
        .online-counter { font-family: 'Montserrat'; font-size: 0.65rem; color: #2ecc71; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .online-dot { width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; display: inline-block; animation: pulse-green 1.5s infinite; }
        @keyframes pulse-green { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }

        /* –¢–£–õ–ë–ê–† */
        .toolbar { 
            position: sticky; top: 0; 
            background: var(--toolbar-bg);
            padding: 10px 15px;
            display: flex; flex-direction: column; gap: 12px;
            z-index: 9500; backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(198, 166, 103, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .tool-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .book-btn {
            background: none; border: 1px solid rgba(198, 166, 103, 0.4);
            color: var(--gold); border-radius: 4px;
            padding: 8px 12px; font-family: 'Montserrat'; font-size: 0.7rem;
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: 0.3s; flex: 1; min-height: 40px; cursor: pointer;
        }
        .book-btn:active { background: var(--gold); color: #000; }
        .book-btn.active { background: var(--gold); color: #000; border-color: var(--gold); }
        .btn-circle { flex: 0 0 40px; border-radius: 50%; padding: 0; font-size: 1.1rem; }

        /* –†–µ–∂–∏–º—ã —á—Ç–µ–Ω–∏—è */
        .view-mode-selector { display: flex; gap: 5px; background: rgba(0,0,0,0.3); padding: 3px; border-radius: 8px; border: 1px solid #333; }
        .mode-btn { border: none; background: none; color: #666; padding: 5px 10px; font-size: 0.7rem; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .mode-btn.active { background: var(--gold); color: #000; }

        .theme-selector { display: flex; gap: 8px; flex: 2; justify-content: center; }
        .t-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: 0.2s; }
        .t-dot.active { border-color: var(--gold); transform: scale(1.1); }

        /* –°—Ç–∏–ª–∏ —á–∏—Ç–∞–ª–∫–∏ */
        .audio-control { position: fixed; bottom: 25px; right: 20px; z-index: 9999; background: rgba(20, 20, 20, 0.8); border: 1px solid var(--gold); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s; }
        .music-playing { animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(198, 166, 103, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(198, 166, 103, 0); } 100% { box-shadow: 0 0 0 0 rgba(198, 166, 103, 0); } }
        
        .hero { min-height: 55vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; background: radial-gradient(circle at center, #1a1a1a 0%, #080808 100%); border-bottom: 1px solid #222; }
        .hero-title { font-family: 'Playfair Display', serif; font-size: clamp(1.2rem, 5vw, 1.8rem); color: var(--gold); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 5px; padding: 0 10px; }
        .hero-subtitle { font-size: 0.7rem; letter-spacing: 2px; opacity: 0.5; margin-bottom: 10px; }
        
        .quote-box { background: linear-gradient(145deg, #161616, #0d0d0d); border: 1px solid var(--gold); padding: 25px 20px; border-radius: 20px; max-width: 420px; cursor: pointer; position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #emil-quote { font-style: italic; font-size: 1rem; line-height: 1.5; color: #eee; transition: opacity 0.3s; min-height: 3em; display: flex; align-items: center; justify-content: center; }
        
        /* –†–ï–ñ–ò–ú –ö–ù–ò–ì–ò (PAGINATION) */
        #reader.mode-book { overflow: hidden; }
        #reader.mode-book .book-content { 
            display: flex; overflow: hidden; width: 100vw; height: 100vh; 
            padding: 0; max-width: none; align-items: stretch;
        }
        .book-page { 
            min-width: 100vw; height: 100%; box-sizing: border-box; 
            padding: 80px 25px 40px; overflow-y: auto; 
            transition: transform 0.5s cubic-bezier(0.645, 0.045, 0.355, 1);
            position: relative;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è */
        .page-transition { transform: translateX(-100%); }

        .container { max-width: 1000px; margin: 0 auto; padding: 0px 15px 100px; }
        .chapters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 15px; }
        .chapter-card { background: var(--card-bg); border: 1px solid #222; border-radius: 12px; padding: 18px 15px; cursor: pointer; transition: 0.3s; min-height: 80px; }
        .chapter-card.completed { border-color: #2ecc71; }

        #reader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9000; overflow-y: auto; }
        .book-content { max-width: 650px; margin: 0 auto; padding: 20px 15px 100px; line-height: 1.8; font-size: 1.15rem; min-height: 100vh; }
        
        .theme-paper { background-color: #f4f1ea !important; color: #1a1a1a !important; }
        .theme-dark { background-color: #0d0d0d !important; color: #d1d1d1 !important; }
        .theme-sepia { background-color: var(--sepia-bg) !important; color: var(--sepia-text) !important; }
        .theme-night { background-color: #030303 !important; color: #666 !important; }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã... */
        #comments-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 20000; }
        .comm-wrapper { display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; background: #080808; }
        .comm-header { padding: 20px; border-bottom: 1px solid #222; color: var(--gold); display: flex; justify-content: space-between; align-items: center; }
        .comm-list { flex: 1; overflow-y: auto; padding: 15px; }
        .comm-item { background: #121212; padding: 15px; margin-bottom: 12px; border-radius: 12px; border-left: 4px solid var(--gold); }
        .comm-input-area { padding: 20px; background: #111; border-top: 1px solid #222; }
        #toast { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); background: var(--gold); color: black; padding: 10px 20px; border-radius: 50px; font-size: 0.75rem; display: none; z-index: 30000; font-weight: bold; }
        
        /* –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ –∫–Ω–∏–≥–∏ */
        .book-nav {
            position: fixed; bottom: 20px; left: 0; width: 100%; 
            display: none; justify-content: center; gap: 20px; z-index: 9600;
        }
        .mode-book .book-nav { display: flex; }
        .nav-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(198, 166, 103, 0.3); }
        .nav-dot.active { background: var(--gold); }
    </style>
</head>
<body onclick="initAudioContext()">
<div id="toast"></div>
<div class="progress-line" id="progLine"></div>

<div class="audio-control" onclick="toggleMusic()" id="musicBtn">
    <span id="musicIcon" style="font-size: 1.2rem;">üéµ</span>
    <audio id="bgMusic" loop>
        <source src="https://stream.zeno.fm/0r0xa792kwzuv" type="audio/mpeg">
    </audio>
</div>

<div id="main-ui">
    <div class="hero">
        <div class="hero-title">–ü–†–ò–ß–£–î–õ–ò–í–´–ï –ê–í–ê–ù–¢–Æ–†–´ –≠–ú–ò–õ–Ø –ì–ò–ï–ù–û–í–ò–ß–ê</div>
        <div class="hero-subtitle">–≠–ú–ò–õ–¨ –°–¢–≠–¢–•–≠–ú</div>
        
        <div class="online-counter">
            <span class="online-dot"></span>
            <span id="onlineCount">–ß–∏—Ç–∞—é—Ç: 14</span> —à–∞–∫–∞–ª–æ–≤ –æ–Ω–ª–∞–π–Ω
        </div>

        <div class="quote-box" onclick="getEmilQuote()">
            <div id="emil-quote">–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–¥—Ä–æ—Å—Ç–∏...</div>
            <div class="quote-hint"><span>üëÜ</span> –ù–∞–∂–º–∏ –Ω–∞ –æ–∫–Ω–æ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ç—å –±–∞–∑—É</div>
            <button class="share-quote-btn" onclick="shareQuote(event)">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –±–∞–∑–æ–π</button>
        </div>

        <div style="margin-top: 25px;">
            <button class="book-btn" onclick="openComments('global')" style="padding: 12px 30px; border-radius: 50px;">üí¨ –û–ë–©–ò–ô –ß–ê–¢</button>
        </div>
    </div>

    <div class="search-container" style="max-width: 1000px; margin: 20px auto 0; padding: 0 15px;">
        <input type="text" id="chapterSearch" placeholder="–ü–æ–∏—Å–∫ –≥–ª–∞–≤—ã..." oninput="renderVolumes()" style="width: 100%; background: #121212; border: 1px solid #333; color: white; padding: 12px 20px; border-radius: 12px;">
    </div>
    
    <div class="container" id="volumes-container"></div>
</div>

<div id="reader" onscroll="onReaderScroll()">
    <div class="toolbar" id="topBar">
        <div class="tool-row">
            <button class="book-btn btn-circle" onclick="closeBook()">‚úï</button>
            <div class="view-mode-selector">
                <button class="mode-btn active" id="modeScroll" onclick="setReadMode('scroll')">üìú –°–∫—Ä–æ–ª–ª</button>
                <button class="mode-btn" id="modeBook" onclick="setReadMode('book')">üìñ –ö–Ω–∏–≥–∞</button>
            </div>
            <div class="theme-selector">
                <div class="t-dot" style="background:#f4f1ea;" onclick="applyTheme('paper', this)"></div>
                <div class="t-dot" style="background:#2b2520;" onclick="applyTheme('sepia', this)"></div>
                <div class="t-dot active" style="background:#0d0d0d;" onclick="applyTheme('dark', this)"></div>
            </div>
        </div>
        <div class="tool-row">
            <button class="book-btn" id="ttsBtn" onclick="toggleTTS()">üìú –ß–∏—Ç–∞—Ç—å –≤—Å–ª—É—Ö</button>
            <div style="display:flex; gap:5px;">
                <button class="book-btn btn-circle" onclick="changeSize(2)">A+</button>
                <button class="book-btn btn-circle" onclick="changeSize(-2)">A-</button>
            </div>
        </div>
    </div>

    <div class="book-content theme-dark" id="textContent">
        <div id="chapterBody"></div>
    </div>

    <div class="book-nav" id="bookNav">
        </div>
</div>

<div id="comments-modal">
    <div class="comm-wrapper">
        <div class="comm-header">
            <span id="commHeaderTitle">–ß–ê–¢</span>
            <button onclick="toggleComments(false)" style="background:none; border:none; color:#fff; font-size: 1.5rem;">&times;</button>
        </div>
        <div class="comm-list" id="commList"></div>
        <div class="comm-input-area">
            <textarea id="commInput" placeholder="–¢–≤–æ–µ –º–Ω–µ–Ω–∏–µ..." rows="2" style="width:100%; background:#000; color:#fff; border:1px solid #444; border-radius:12px; padding:10px;"></textarea>
            <div class="comm-btns" style="display:flex; gap:10px; margin-top:10px;">
                <button class="book-btn" id="sendBtn" style="background:var(--gold); color:#000;">–û–¢–ü–†–ê–í–ò–¢–¨</button>
            </div>
        </div>
    </div>
</div>

<script src="chapters.js"></script>
<script type="module">
    // –ó–¥–µ—Å—å –≤–∞—à Firebase –∫–æ–¥ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, runTransaction, serverTimestamp, onDisconnect, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDD43BfRt9tkn4k0pgTRuQ7-SCR_PmjR8c",
        authDomain: "emilka-site.firebaseapp.com",
        projectId: "emilka-site",
        databaseURL: "https://emilka-site-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentTopic = 'global';

    // (–î—É–±–ª–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–æ–∫)
    window.openComments = function(topic) {
        currentTopic = topic;
        document.getElementById('comments-modal').style.display = 'block';
        // –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...
    };
    window.toggleComments = (s) => document.getElementById('comments-modal').style.display = s ? 'block' : 'none';
</script>

<script>
    const reader = document.getElementById('reader');
    const textContent = document.getElementById('textContent');
    const progLine = document.getElementById('progLine');
    let currentId = 1;
    let readMode = 'scroll'; // 'scroll' –∏–ª–∏ 'book'
    let currentPage = 0;
    let totalPages = 0;

    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –†–ï–ñ–ò–ú–û–í ---

    function setReadMode(mode) {
        readMode = mode;
        localStorage.setItem('emil_read_mode', mode);
        
        document.getElementById('modeScroll').classList.toggle('active', mode === 'scroll');
        document.getElementById('modeBook').classList.toggle('active', mode === 'book');
        reader.className = mode === 'book' ? 'mode-book' : '';
        
        // –ü–µ—Ä–µ—Å–æ–±–µ—Ä–µ–º –≥–ª–∞–≤—É –ø–æ–¥ –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
        openChapter(currentId, true);
    }

    function openChapter(id, keepPosition = false) {
        currentId = id;
        const ch = bookData.find(c => c.id === id);
        if(!ch) return;

        reader.style.display = 'block';
        document.body.style.overflow = 'hidden';

        if (readMode === 'scroll') {
            renderScrollMode(ch, keepPosition);
        } else {
            renderBookMode(ch);
        }
        
        if(window.loadChapReacts) window.loadChapReacts(id);
    }

    function renderScrollMode(ch, keepPosition) {
        textContent.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h1 style="color:var(--gold); font-family: 'Playfair Display';">${ch.id}. ${ch.title}</h1>
            </div>
            <div id="chapterBody">${ch.content.replace(/\n/g, '<br><br>')}</div>
            <div style="margin-top:50px; display:flex; gap:10px;">
                 <button class="book-btn" onclick="prevChapter()">–ù–∞–∑–∞–¥</button>
                 <button class="book-btn" onclick="nextChapter()">–í–ø–µ—Ä–µ–¥</button>
            </div>
        `;
        if(!keepPosition) {
            const saved = JSON.parse(localStorage.getItem(`p_v11_${ch.id}`) || '{"pos":0}');
            setTimeout(() => { reader.scrollTop = saved.pos; }, 50);
        }
    }

    function renderBookMode(ch) {
        const words = ch.content.split(' ');
        const charsPerPage = 800; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª-–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const pages = [];
        
        // –ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–≤ –∏–¥–µ–∞–ª–µ –Ω—É–∂–Ω–æ –º–µ—Ä–∏—Ç—å –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        for (let i = 0; i < ch.content.length; i += charsPerPage) {
            pages.push(ch.content.substring(i, i + charsPerPage));
        }

        totalPages = pages.length;
        currentPage = 0;

        textContent.innerHTML = pages.map((p, i) => `
            <div class="book-page" id="page-${i}" onclick="handlePageClick(event)">
                <div style="font-size:0.7rem; color:var(--gold); margin-bottom:10px;">–ì–õ–ê–í–ê ${ch.id} / –°–¢–† ${i+1}</div>
                ${p.replace(/\n/g, '<br><br>')}
                ${i === totalPages - 1 ? '<br><br><button class="book-btn" onclick="nextChapter()">–°–õ–ï–î. –ì–õ–ê–í–ê</button>' : ''}
            </div>
        `).join('');

        updateBookNav();
    }

    function handlePageClick(e) {
        if (readMode !== 'book') return;
        const width = window.innerWidth;
        if (e.clientX > width * 0.7) {
            navigatePage(1); // –ö–ª–∏–∫ —Å–ø—Ä–∞–≤–∞ - –≤–ø–µ—Ä–µ–¥
        } else if (e.clientX < width * 0.3) {
            navigatePage(-1); // –ö–ª–∏–∫ —Å–ª–µ–≤–∞ - –Ω–∞–∑–∞–¥
        }
    }

    function navigatePage(dir) {
        const next = currentPage + dir;
        if (next >= 0 && next < totalPages) {
            currentPage = next;
            const offset = -currentPage * 100;
            document.querySelectorAll('.book-page').forEach(p => {
                p.style.transform = `translateX(${offset}vw)`;
            });
            updateBookNav();
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            const perc = Math.round((currentPage / (totalPages - 1)) * 100);
            progLine.style.width = perc + "%";
        } else if (next >= totalPages) {
            nextChapter();
        } else if (next < 0) {
            prevChapter();
        }
    }

    function updateBookNav() {
        const nav = document.getElementById('bookNav');
        nav.innerHTML = Array.from({length: totalPages}).map((_, i) => 
            `<div class="nav-dot ${i === currentPage ? 'active' : ''}"></div>`
        ).join('');
    }

    // --- –°–¢–ê–†–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ (–°–û–•–†–ê–ù–ï–ù) ---

    function onReaderScroll() {
        if (readMode !== 'scroll') return;
        const scrolled = (reader.scrollTop / (reader.scrollHeight - reader.clientHeight)) * 100;
        progLine.style.width = scrolled + "%";
        localStorage.setItem(`p_v11_${currentId}`, JSON.stringify({perc: Math.round(scrolled), pos: reader.scrollTop}));
    }

    function closeBook() { 
        reader.style.display = 'none'; 
        document.body.style.overflow = 'auto'; 
        renderVolumes(); 
    }

    function nextChapter() { if(currentId < bookData.length) openChapter(currentId + 1); }
    function prevChapter() { if(currentId > 1) openChapter(currentId - 1); }

    function applyTheme(t, el) {
        textContent.className = `book-content theme-${t}`;
        document.querySelectorAll('.t-dot').forEach(d => d.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    function changeSize(d) {
        const s = parseFloat(window.getComputedStyle(textContent).fontSize);
        textContent.style.fontSize = (s + d) + 'px';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = () => { 
        const savedMode = localStorage.getItem('emil_read_mode') || 'scroll';
        setReadMode(savedMode);
        renderVolumes(); 
        if(window.getEmilQuote) getEmilQuote(); 
    };

    // (–î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: renderVolumes, getEmilQuote, TTS –∏ —Ç.–¥. –∏–∑ –≤–∞—à–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)
    // –û–Ω–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ —Ä–∞–±–æ—Ç–∞–ª–∏.
</script>
</body>
</html>
